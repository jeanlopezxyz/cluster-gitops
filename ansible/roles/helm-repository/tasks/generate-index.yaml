---
# Generate Helm repository index
# Red Hat Consulting

- name: Check if helm is installed
  ansible.builtin.command:
    cmd: which helm
  register: helm_check
  ignore_errors: true
  changed_when: false

- name: Install Helm if not present
  when: helm_check.rc != 0
  block:
    - name: Download Helm installer script
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: "0700"
      become: true

    - name: Install Helm
      ansible.builtin.command:
        cmd: /tmp/get_helm.sh
      become: true
      changed_when: true

- name: Generate Helm repo index
  ansible.builtin.command:
    cmd: >
      helm repo index {{ helm_repo.chartmuseum.storage_path }}
      --url http://{{ bastion_host | default(ansible_host) | default('localhost') }}:{{ helm_repo.chartmuseum.port }}/charts
    chdir: "{{ helm_repo.chartmuseum.storage_path }}"
  become: true
  changed_when: true

- name: List available charts
  ansible.builtin.uri:
    url: "http://localhost:{{ helm_repo.chartmuseum.port }}/api/charts"
    method: GET
    return_content: true
  register: available_charts

- name: Display available charts
  ansible.builtin.debug:
    msg: "ðŸ“‹ Available charts: {{ available_charts.json | default({}) | list | join(', ') }}"
  when: available_charts.json is defined

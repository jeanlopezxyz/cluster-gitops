---
# ChartMuseum container setup tasks
# Red Hat Consulting

- name: Pull ChartMuseum image
  containers.podman.podman_image:
    name: "{{ helm_repo.chartmuseum.image }}"
    state: present
  become: true

- name: Stop existing ChartMuseum container if running
  containers.podman.podman_container:
    name: "{{ helm_repo.chartmuseum.container_name }}"
    state: absent
  become: true
  ignore_errors: true

- name: Create ChartMuseum container
  containers.podman.podman_container:
    name: "{{ helm_repo.chartmuseum.container_name }}"
    image: "{{ helm_repo.chartmuseum.image }}"
    state: started
    restart_policy: always
    ports:
      - "{{ helm_repo.chartmuseum.port }}:8080"
    volumes:
      - "{{ helm_repo.chartmuseum.storage_path }}:/charts:z"
    env:
      STORAGE: local
      STORAGE_LOCAL_ROOTDIR: /charts
      DISABLE_API: "false"
      ALLOW_OVERWRITE: "true"
      DEBUG: "false"
    generate_systemd:
      path: /etc/systemd/system
      restart_policy: always
  become: true

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  become: true

- name: Enable and start ChartMuseum systemd service
  ansible.builtin.systemd:
    name: "container-{{ helm_repo.chartmuseum.container_name }}"
    state: started
    enabled: true
  become: true
  when: systemd.enabled | default(true)

- name: Wait for ChartMuseum to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ helm_repo.chartmuseum.port }}/health"
    method: GET
    status_code: 200
  register: chartmuseum_health
  until: chartmuseum_health.status == 200
  retries: 30
  delay: 2

- name: Display ChartMuseum status
  ansible.builtin.debug:
    msg: "âœ… ChartMuseum is running and healthy"

---
# Main tasks for helm-repository role
# Red Hat Consulting - Simple Nginx-based Helm Repository

- name: Display Helm repository setup banner
  ansible.builtin.debug:
    msg: "ğŸ“¦ Setting up Helm Chart Repository on bastion"

- name: Install Nginx
  ansible.builtin.dnf:
    name:
      - nginx
      - firewalld
    state: present
  become: true

- name: Create charts directory
  ansible.builtin.file:
    path: "{{ helm_repo.document_root }}"
    state: directory
    mode: "0755"
    owner: nginx
    group: nginx
  become: true

- name: Find all packaged charts
  ansible.builtin.find:
    paths: "{{ helm_repo.charts_source_dir }}"
    patterns: "*.tgz"
    recurse: false
  register: chart_packages
  delegate_to: localhost

- name: Copy charts to web directory
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "{{ helm_repo.document_root }}/"
    mode: "0644"
    owner: nginx
    group: nginx
  loop: "{{ chart_packages.files }}"
  become: true

- name: Copy index.yaml if exists
  ansible.builtin.copy:
    src: "{{ helm_repo.charts_source_dir }}/index.yaml"
    dest: "{{ helm_repo.document_root }}/index.yaml"
    mode: "0644"
    owner: nginx
    group: nginx
  become: true
  ignore_errors: true

- name: Configure Nginx for Helm repository
  ansible.builtin.template:
    src: nginx-helm-repo.conf.j2
    dest: /etc/nginx/conf.d/helm-repo.conf
    mode: "0644"
  become: true
  notify: Restart nginx

- name: Ensure firewalld is running
  ansible.builtin.systemd:
    name: firewalld
    state: started
    enabled: true
  become: true
  when: firewall.enabled | default(true)

- name: Open firewall port
  ansible.posix.firewalld:
    port: "{{ helm_repo.port }}/tcp"
    permanent: true
    state: enabled
    zone: "{{ firewall.zone | default('public') }}"
  become: true
  when: firewall.enabled | default(true)
  notify: Reload firewalld

- name: Enable and start Nginx
  ansible.builtin.systemd:
    name: nginx
    state: started
    enabled: true
  become: true

- name: Generate Helm index if not exists
  ansible.builtin.command:
    cmd: >
      helm repo index {{ helm_repo.document_root }}
      --url http://{{ ansible_host | default('localhost') }}:{{ helm_repo.port }}
  become: true
  changed_when: true

- name: Set correct permissions on index.yaml
  ansible.builtin.file:
    path: "{{ helm_repo.document_root }}/index.yaml"
    mode: "0644"
    owner: nginx
    group: nginx
  become: true

- name: Display completion message
  ansible.builtin.debug:
    msg: |
      âœ… Helm Repository configured!
      ğŸ“ URL: http://{{ ansible_host | default('localhost') }}:{{ helm_repo.port }}
      ğŸ“ Add repo: helm repo add day2-charts http://{{ ansible_host | default('localhost') }}:{{ helm_repo.port }}
